{"version":3,"sources":["GameMgr.js"],"names":["Define","require","GameMgr","cc","Class","extends","Component","statics","instance","onLoad","game","addPersistRootNode","node","matchData","start","GSMgr","registerOpCodeCallback","ServerCode","RP_ENTER_SEAT","onPlayerEnterSeat","bind","RP_LEAVE_SEAT","onPlayerLeaveSeat","RP_LOAD_MATCH","onMatchLoad","RP_HOST_CHANGE","onHostChange","RP_STATE_UPDATE","onGameStateUpdate","RP_GET_CARDS","onCardsReceived","onInit","startGameScene","OnMatchFound","message","console","log","JSON","stringify","onlineList","participants","OnMatchUpdate","hasOwnProperty","player","filter","id","addedPlayers","UIManager","addPlayer","removedPlayers","removePlayer","onMatchLoaded","callback","onMatchLoadedCb","parse","getString","getCurrentSeats","Seats","getPlayer","getOnlineList","getHost","Host","UpdateUserInfo","userId","getMyId","getMySeat","MySeat","IsMyId","playerId","seat","getLong","playerEnterSeat","playerLeaveSeat","setHost","State","GameState","WAITING","onGameStateWaiting","READY","onGameStateReady","setEnableStartButton","cards","sort","a","b"],"mappings":"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","file":"GameMgr.js","sourceRoot":"../../../../../assets/Script/Game","sourcesContent":["var Define = require(\"Define\");\nvar GameMgr = cc.Class({\n    extends: cc.Component,\n\n    statics: {\n        instance: null\n    },\n\n    onLoad()\n    {\n        GameMgr.instance = this;\n        cc.game.addPersistRootNode(this.node);\n        this.matchData={};\n    },\n\n    start()\n    {\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_ENTER_SEAT, this.onPlayerEnterSeat.bind(this));\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_LEAVE_SEAT, this.onPlayerLeaveSeat.bind(this));\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_LOAD_MATCH, this.onMatchLoad.bind(this));\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_HOST_CHANGE, this.onHostChange.bind(this));\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_STATE_UPDATE, this.onGameStateUpdate.bind(this));\n        GSMgr.instance.registerOpCodeCallback(ServerCode.RP_GET_CARDS, this.onCardsReceived.bind(this));\n    },\n\n    onInit()\n    {\n        this.startGameScene = true;\n    },\n\n    OnMatchFound(message)\n    {\n        console.log(\"Game on match found \" + JSON.stringify(message));\n        this.onlineList = message.participants;\n    },\n\n    OnMatchUpdate(message)\n    {\n        console.log(\"Game on match update \" + JSON.stringify(message));\n        this.onlineList = message.participants;\n        if (message.hasOwnProperty(\"addedPlayers\"))\n        {\n            let player = this.onlineList.filter(player => player.id == message.addedPlayers)[0];\n                UIManager.instance.addPlayer(player);\n        }\n        if (message.hasOwnProperty(\"removedPlayers\"))\n        {\n            let player = message.removedPlayers[0];\n                UIManager.instance.removePlayer(player);\n        }\n    },\n\n    onMatchLoaded(callback)\n    {\n        this.onMatchLoadedCb = callback;\n    },\n\n    onMatchLoad(message)\n    {\n        this.matchData = JSON.parse(message.getString(1));\n        if (this.onMatchLoadedCb)\n            this.onMatchLoadedCb();\n    },\n\n    getCurrentSeats()\n    {\n        if (this.matchData)\n            return this.matchData.Seats;\n        return {};\n    },\n\n    getPlayer(id)\n    {\n        return this.onlineList.filter(player => player.id == id)[0];\n    },\n\n    getOnlineList()\n    {\n        return this.onlineList;\n    },\n\n    getHost()\n    {\n        return this.matchData.Host;\n    },\n\n    UpdateUserInfo(message) {\n        this.userId = message.userId;\n    },\n\n    getMyId()\n    {\n        return this.userId;\n    },\n\n    getMySeat()\n    {\n        return this.MySeat;\n    },\n\n    IsMyId(id)\n    {\n        return this.userId == id;\n    },\n\n    onPlayerEnterSeat(message)\n    {\n        let playerId = message.getString(1);\n        let seat = message.getLong(2);\n            this.matchData.Seats[seat] = playerId;\n            UIManager.instance.playerEnterSeat(this.getPlayer(playerId), seat);\n\n        if (this.IsMyId(playerId))\n        {\n            this.MySeat = seat;\n        }\n    },\n\n    onPlayerLeaveSeat(message)\n    {\n        let playerId = message.getString(1);\n        let seat = message.getLong(2);\n            this.matchData.Seats[seat] = null;\n            UIManager.instance.playerLeaveSeat(seat);\n        \n        if (this.IsMyId(playerId))\n        {\n            this.MySeat = null;\n        }\n    },\n\n    onHostChange(message)\n    {\n        let playerId = message.getString(1);\n            this.matchData.Host = playerId;\n            UIManager.instance.setHost(playerId);\n    },\n\n    onGameStateUpdate(message)\n    {\n        this.matchData.State = message.getLong(1);\n        switch (this.matchData.State)\n        {\n            case Define.GameState.WAITING:\n                this.onGameStateWaiting();\n            break;\n\n            case Define.GameState.READY:\n                this.onGameStateReady();\n            break;\n        }\n    },\n\n    onGameStateWaiting()\n    {\n        if (this.IsMyId(this.matchData.Host))\n            UIManager.instance.setEnableStartButton(false);\n    },\n\n    onGameStateReady()\n    {\n        if (this.IsMyId(this.matchData.Host))\n            UIManager.instance.setEnableStartButton(true);\n    },\n\n    onCardsReceived(message)\n    {\n        var cards = JSON.parse(message.getString(1));\n        cards.sort((a,b) => a - b);\n        UIManager.instance.onCardsReceived(cards);\n    },\n});"]}